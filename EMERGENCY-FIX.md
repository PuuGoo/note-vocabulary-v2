# ?? EMERGENCY FIX - EADDRINUSE Error

## V?n ??
```
Error: bind EADDRINUSE 0.0.0.0:3000
```

PM2 cluster mode ?ang c? g?ng ch?y nhi?u instances cùng lúc, gây xung ??t port 3000.

---

## ? Gi?i Pháp Nhanh (30 Giây)

### **Ch?y trên VPS:**

```bash
# SSH vào VPS
ssh root@165.227.101.102

# Vào th? m?c
cd /root/vocapro

# Pull code m?i (?ã fix ecosystem.config.js)
git pull origin main

# Ch?y emergency fix script
chmod +x emergency-fix.sh
bash emergency-fix.sh
```

Script s?:
1. ? Stop t?t c? PM2 processes
2. ? Kill b?t k? process nào ?ang chi?m port 3000
3. ? Pull config m?i (fork mode thay vì cluster)
4. ? Start l?i ?ng d?ng
5. ? Test health check

---

## ?? Ho?c Fix Th? Công

```bash
# 1. Stop t?t c? PM2
pm2 delete all

# 2. Kill port 3000
sudo lsof -ti:3000 | xargs -r sudo kill -9

# 3. Pull config m?i
git pull origin main

# 4. Start l?i
pm2 start ecosystem.config.js --env production

# 5. Save
pm2 save

# 6. Check
pm2 status
pm2 logs vocapro --lines 50
```

---

## ?? K?t Qu? Mong ??i

Sau khi ch?y, b?n s? th?y:

```
???????????????????????????????????????????????????????????????
? id  ? name     ? namespace   ? version ? mode    ? status   ?
???????????????????????????????????????????????????????????????
? 0   ? vocapro  ? default     ? 1.0.0   ? fork    ? online   ?
???????????????????????????????????????????????????????????????
```

**Quan tr?ng:**
- ? `mode: fork` (không ph?i cluster)
- ? `status: online`
- ? Ch? có **1 instance**

---

## ?? Ki?m Tra

```bash
# Test health
curl http://localhost:3000/health

# Xem logs
pm2 logs vocapro

# Check port
sudo lsof -i :3000
```

N?u OK, m? browser: **http://165.227.101.102**

---

## ?? Gi?i Thích

**Tr??c (L?i):**
```js
instances: 'max',     // ? Ch?y nhi?u instances
exec_mode: 'cluster', // ? Cluster mode
```

**Sau (Fixed):**
```js
instances: 1,         // ? Ch? 1 instance
exec_mode: 'fork',    // ? Fork mode
```

**T?i sao?**
- V?i VPS nh? (1GB RAM), ch?y 1 instance là ??
- Cluster mode ph?c t?p h?n, d? gây l?i
- Fork mode ??n gi?n, ?n ??nh h?n

---

## ?? N?u V?n L?i

```bash
# Xem process ?ang chi?m port 3000
sudo lsof -i :3000

# Kill t?t c?
sudo lsof -ti:3000 | xargs sudo kill -9

# Restart PM2 daemon
pm2 kill
pm2 start ecosystem.config.js --env production
```

---

## ? Checklist

- [ ] `pm2 delete all` - Xóa t?t c? processes
- [ ] Kill port 3000
- [ ] `git pull origin main` - Pull config m?i
- [ ] `pm2 start ecosystem.config.js --env production`
- [ ] `pm2 status` - Status là "online"
- [ ] `curl http://localhost:3000/health` - Tr? v? OK
- [ ] Browser: http://165.227.101.102 - Hi?n th? VocaPro
